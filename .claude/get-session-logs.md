---
name: get-session-logs
description: Fetch and display Anvil session logs for a GitHub issue. Use when the user wants to view session logs, debug a user's session, see what happened during an error, or says "get session logs for issue #X", "show me the logs", "what did the user do".
---

# Get Session Logs

Fetch Anvil session logs for a GitHub issue that contains a session link.

## Usage

```
/get-session-logs {issue_number}
```

## Prerequisites

### Anvil Session Logs Access (Required)

To fetch session logs from Anvil, set the `ANVIL_AUTH_COOKIES` environment variable:

```bash
export ANVIL_AUTH_COOKIES="anvil_auth=YOUR_ANVIL_AUTH_COOKIE; ring-session=YOUR_RING_SESSION_COOKIE"
```

**To get your cookies:**
1. Open the Anvil IDE in Chrome
2. Open DevTools (F12) → Application tab → Cookies → `viper.anvil.works`
3. Copy the values for `anvil_auth` and `ring-session`

**Note:** The `ring-session` cookie expires when the browser closes, so you may need to refresh it periodically.

## Workflow

### Step 1: Validate Input

Accept issue number from `$ARGUMENTS`. If not provided, ask user.

Fetch the issue:
```bash
gh issue view $ARGUMENTS --json number,title,body
```

### Step 2: Extract Session ID

Parse the issue body to find the session link:

**Pattern to match:**
```
https://viper.anvil.works/build/apps/.../sessions/{SESSION_ID}#logs
```

The session ID is the alphanumeric string before `#logs`.

**If no session ID found:**
> ℹ️ No session link found in issue #{number}.
>
> Session links typically look like:
> `[View Session Logs](https://viper.anvil.works/build/apps/.../sessions/ABC123#logs)`
>
> This issue may not have been auto-generated by the error handler, or the session link was not included.

### Step 3: Check Environment

Verify `ANVIL_AUTH_COOKIES` is set:

```bash
if [ -z "$ANVIL_AUTH_COOKIES" ]; then
  echo "ANVIL_AUTH_COOKIES not set"
fi
```

**If not set:**
> ⚠️ `ANVIL_AUTH_COOKIES` environment variable is not set.
>
> To fetch session logs, you need to set your Anvil auth cookies:
> ```bash
> export ANVIL_AUTH_COOKIES="anvil_auth=YOUR_COOKIE; ring-session=YOUR_COOKIE"
> ```
>
> See the skill prerequisites for instructions on getting your cookies.

### Step 4: Fetch Session Logs

Fetch the session logs from Anvil:

```bash
SESSION_ID="extracted_session_id"
curl -s "https://viper.anvil.works/ide/apps/7BFWWU5AZVWM5IVB/sessions/${SESSION_ID}" \
  -H "Accept: application/json" \
  -H "Cookie: ${ANVIL_AUTH_COOKIES}" | jq -r '.log_text'
```

### Step 5: Handle Errors

| HTTP Status | Meaning | Response |
|-------------|---------|----------|
| 200 | Success | Display the logs |
| 401 | Auth expired | "⚠️ Authentication failed. Your cookies may have expired. Please refresh `ANVIL_AUTH_COOKIES`." |
| 404 | Session not found | "⚠️ Session not found. The session may have expired or been deleted. Anvil sessions are retained for a limited time." |
| Other | Unknown error | "⚠️ Failed to fetch session logs. HTTP status: {code}" |

### Step 6: Analyze and Display Logs

If logs were successfully retrieved, analyze them for:

**User Journey:**
- What forms/pages did they visit before the error?
- What actions did they take?

**Timing:**
- When did the session start?
- How long was the session active before the error?

**Data Context:**
- What specific records/assets were being accessed?
- Which company/project were they working in?

**Error Context:**
- Were there earlier warnings or errors before the main error?
- What operation triggered the crash?

### Step 7: Output Format

Display the session analysis:

```markdown
## Session Logs for Issue #{number}

**Session ID:** `{session_id}`
**Session URL:** [View in Anvil]({session_url})

---

### User Journey
1. {First action/form loaded}
2. {Subsequent actions}
3. {Action that triggered the error}

### Key Observations
- **Forms visited:** {list of forms from logs}
- **Data accessed:** {assets, work orders, etc. mentioned in logs}
- **Time in session:** {duration from start to error}
- **Prior errors:** {any warnings before the main error}

---

### Raw Logs

<details>
<summary>Click to expand full session logs</summary>

```
{raw log text}
```

</details>
```

---

## Error Handling Summary

| Scenario | Action |
|----------|--------|
| Issue not found | "Issue #{n} not found. Check the number and try again." |
| No session ID in issue | Explain that no session link was found |
| ANVIL_AUTH_COOKIES not set | Provide setup instructions |
| Auth failed (401) | "Cookies expired - please refresh ANVIL_AUTH_COOKIES" |
| Session not found (404) | "Session expired or deleted" |
| Empty logs | "Session logs are empty - session may have been very short" |

---

## Integration Points

| Skill | Relationship |
|-------|--------------|
| `@investigate-bug` | May use this to get additional context during investigation |
| `@fix-planner` | Session context can inform fix approach |
